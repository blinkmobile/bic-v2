var REGEXP_UNICODE=function(){for(var a=[" ","\u0120",-1,"!","\u0120",-1,"\u0120","\u0120",0,"\u0121","\u0120",-1,"\u0121","\u0120|\u0121",0,"\u0122","\u0120|\u0121",-1,"\u0120","[\u0120]",0,"\u0121","[\u0120]",-1,"\u0121","[\u0120\u0121]",0,"\u0122","[\u0120\u0121]",-1,"\u0121","[\u0120-\u0121]",0,"\u0122","[\u0120-\u0121]",-1],b=0;b<a.length;b+=3)if(a[b].search(RegExp(a[b+1]))!=a[b+2])return false;return true}(),XML_S="[ \t\r\n]+",XML_EQ="("+XML_S+")?=("+XML_S+")?",XML_CHAR_REF="&#[0-9]+;|&#x[0-9a-fA-F]+;",
XML10_VERSION_INFO=XML_S+"version"+XML_EQ+"(\"1\\.0\"|'1\\.0')",XML10_BASE_CHAR=REGEXP_UNICODE?"A-Za-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u00ff\u0100-\u0131\u0134-\u013e\u0141-\u0148\u014a-\u017e\u0180-\u01c3\u01cd-\u01f0\u01f4-\u01f5\u01fa-\u0217\u0250-\u02a8\u02bb-\u02c1\u0386\u0388-\u038a\u038c\u038e-\u03a1\u03a3-\u03ce\u03d0-\u03d6\u03da\u03dc\u03de\u03e0\u03e2-\u03f3\u0401-\u040c\u040e-\u044f\u0451-\u045c\u045e-\u0481\u0490-\u04c4\u04c7-\u04c8\u04cb-\u04cc\u04d0-\u04eb\u04ee-\u04f5\u04f8-\u04f9\u0531-\u0556\u0559\u0561-\u0586\u05d0-\u05ea\u05f0-\u05f2\u0621-\u063a\u0641-\u064a\u0671-\u06b7\u06ba-\u06be\u06c0-\u06ce\u06d0-\u06d3\u06d5\u06e5-\u06e6\u0905-\u0939\u093d\u0958-\u0961\u0985-\u098c\u098f-\u0990\u0993-\u09a8\u09aa-\u09b0\u09b2\u09b6-\u09b9\u09dc-\u09dd\u09df-\u09e1\u09f0-\u09f1\u0a05-\u0a0a\u0a0f-\u0a10\u0a13-\u0a28\u0a2a-\u0a30\u0a32-\u0a33\u0a35-\u0a36\u0a38-\u0a39\u0a59-\u0a5c\u0a5e\u0a72-\u0a74\u0a85-\u0a8b\u0a8d\u0a8f-\u0a91\u0a93-\u0aa8\u0aaa-\u0ab0\u0ab2-\u0ab3\u0ab5-\u0ab9\u0abd\u0ae0\u0b05-\u0b0c\u0b0f-\u0b10\u0b13-\u0b28\u0b2a-\u0b30\u0b32-\u0b33\u0b36-\u0b39\u0b3d\u0b5c-\u0b5d\u0b5f-\u0b61\u0b85-\u0b8a\u0b8e-\u0b90\u0b92-\u0b95\u0b99-\u0b9a\u0b9c\u0b9e-\u0b9f\u0ba3-\u0ba4\u0ba8-\u0baa\u0bae-\u0bb5\u0bb7-\u0bb9\u0c05-\u0c0c\u0c0e-\u0c10\u0c12-\u0c28\u0c2a-\u0c33\u0c35-\u0c39\u0c60-\u0c61\u0c85-\u0c8c\u0c8e-\u0c90\u0c92-\u0ca8\u0caa-\u0cb3\u0cb5-\u0cb9\u0cde\u0ce0-\u0ce1\u0d05-\u0d0c\u0d0e-\u0d10\u0d12-\u0d28\u0d2a-\u0d39\u0d60-\u0d61\u0e01-\u0e2e\u0e30\u0e32-\u0e33\u0e40-\u0e45\u0e81-\u0e82\u0e84\u0e87-\u0e88\u0e8a\u0e8d\u0e94-\u0e97\u0e99-\u0e9f\u0ea1-\u0ea3\u0ea5\u0ea7\u0eaa-\u0eab\u0ead-\u0eae\u0eb0\u0eb2-\u0eb3\u0ebd\u0ec0-\u0ec4\u0f40-\u0f47\u0f49-\u0f69\u10a0-\u10c5\u10d0-\u10f6\u1100\u1102-\u1103\u1105-\u1107\u1109\u110b-\u110c\u110e-\u1112\u113c\u113e\u1140\u114c\u114e\u1150\u1154-\u1155\u1159\u115f-\u1161\u1163\u1165\u1167\u1169\u116d-\u116e\u1172-\u1173\u1175\u119e\u11a8\u11ab\u11ae-\u11af\u11b7-\u11b8\u11ba\u11bc-\u11c2\u11eb\u11f0\u11f9\u1e00-\u1e9b\u1ea0-\u1ef9\u1f00-\u1f15\u1f18-\u1f1d\u1f20-\u1f45\u1f48-\u1f4d\u1f50-\u1f57\u1f59\u1f5b\u1f5d\u1f5f-\u1f7d\u1f80-\u1fb4\u1fb6-\u1fbc\u1fbe\u1fc2-\u1fc4\u1fc6-\u1fcc\u1fd0-\u1fd3\u1fd6-\u1fdb\u1fe0-\u1fec\u1ff2-\u1ff4\u1ff6-\u1ffc\u2126\u212a-\u212b\u212e\u2180-\u2182\u3041-\u3094\u30a1-\u30fa\u3105-\u312c\uac00-\ud7a3":
"A-Za-z",XML10_IDEOGRAPHIC=REGEXP_UNICODE?"\u4e00-\u9fa5\u3007\u3021-\u3029":"",XML10_COMBINING_CHAR=REGEXP_UNICODE?"\u0300-\u0345\u0360-\u0361\u0483-\u0486\u0591-\u05a1\u05a3-\u05b9\u05bb-\u05bd\u05bf\u05c1-\u05c2\u05c4\u064b-\u0652\u0670\u06d6-\u06dc\u06dd-\u06df\u06e0-\u06e4\u06e7-\u06e8\u06ea-\u06ed\u0901-\u0903\u093c\u093e-\u094c\u094d\u0951-\u0954\u0962-\u0963\u0981-\u0983\u09bc\u09be\u09bf\u09c0-\u09c4\u09c7-\u09c8\u09cb-\u09cd\u09d7\u09e2-\u09e3\u0a02\u0a3c\u0a3e\u0a3f\u0a40-\u0a42\u0a47-\u0a48\u0a4b-\u0a4d\u0a70-\u0a71\u0a81-\u0a83\u0abc\u0abe-\u0ac5\u0ac7-\u0ac9\u0acb-\u0acd\u0b01-\u0b03\u0b3c\u0b3e-\u0b43\u0b47-\u0b48\u0b4b-\u0b4d\u0b56-\u0b57\u0b82-\u0b83\u0bbe-\u0bc2\u0bc6-\u0bc8\u0bca-\u0bcd\u0bd7\u0c01-\u0c03\u0c3e-\u0c44\u0c46-\u0c48\u0c4a-\u0c4d\u0c55-\u0c56\u0c82-\u0c83\u0cbe-\u0cc4\u0cc6-\u0cc8\u0cca-\u0ccd\u0cd5-\u0cd6\u0d02-\u0d03\u0d3e-\u0d43\u0d46-\u0d48\u0d4a-\u0d4d\u0d57\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb-\u0ebc\u0ec8-\u0ecd\u0f18-\u0f19\u0f35\u0f37\u0f39\u0f3e\u0f3f\u0f71-\u0f84\u0f86-\u0f8b\u0f90-\u0f95\u0f97\u0f99-\u0fad\u0fb1-\u0fb7\u0fb9\u20d0-\u20dc\u20e1\u302a-\u302f\u3099\u309a":
"",XML10_DIGIT=REGEXP_UNICODE?"0-9\u0660-\u0669\u06f0-\u06f9\u0966-\u096f\u09e6-\u09ef\u0a66-\u0a6f\u0ae6-\u0aef\u0b66-\u0b6f\u0be7-\u0bef\u0c66-\u0c6f\u0ce6-\u0cef\u0d66-\u0d6f\u0e50-\u0e59\u0ed0-\u0ed9\u0f20-\u0f29":"0-9",XML10_EXTENDER=REGEXP_UNICODE?"\u00b7\u02d0\u02d1\u0387\u0640\u0e46\u0ec6\u3005\u3031-\u3035\u309d-\u309e\u30fc-\u30fe":"",XML10_LETTER=XML10_BASE_CHAR+XML10_IDEOGRAPHIC,XML10_NAME_CHAR=XML10_LETTER+XML10_DIGIT+"\\._:"+XML10_COMBINING_CHAR+XML10_EXTENDER+"-",XML10_NAME="["+XML10_LETTER+
"_:]["+XML10_NAME_CHAR+"]*",XML10_ENTITY_REF="&"+XML10_NAME+";",XML10_REFERENCE=XML10_ENTITY_REF+"|"+XML_CHAR_REF,XML10_ATT_VALUE='"(([^<&"]|'+XML10_REFERENCE+")*)\"|'(([^<&']|"+XML10_REFERENCE+")*)'",XML10_ATTRIBUTE="("+XML10_NAME+")"+XML_EQ+"("+XML10_ATT_VALUE+")",XML11_VERSION_INFO=XML_S+"version"+XML_EQ+"(\"1\\.1\"|'1\\.1')",XML11_NAME_START_CHAR=REGEXP_UNICODE?":A-Z_a-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u02ff\u0370-\u037d\u037f-\u1fff\u200c-\u200d\u2070-\u218f\u2c00-\u2fef\u3001-\ud7ff\uf900-\ufdcf\ufdf0-\ufffd":
":A-Z_a-z",XML11_NAME_CHAR=XML11_NAME_START_CHAR+(REGEXP_UNICODE?"\\.0-9\u00b7\u0300-\u036f\u203f-\u2040-":"\\.0-9-"),XML11_NAME="["+XML11_NAME_START_CHAR+"]["+XML11_NAME_CHAR+"]*",XML11_ENTITY_REF="&"+XML11_NAME+";",XML11_REFERENCE=XML11_ENTITY_REF+"|"+XML_CHAR_REF,XML11_ATT_VALUE='"(([^<&"]|'+XML11_REFERENCE+")*)\"|'(([^<&']|"+XML11_REFERENCE+")*)'",XML11_ATTRIBUTE="("+XML11_NAME+")"+XML_EQ+"("+XML11_ATT_VALUE+")",XML_NC_NAME_CHAR=XML10_LETTER+XML10_DIGIT+"\\._"+XML10_COMBINING_CHAR+XML10_EXTENDER+
"-",XML_NC_NAME="["+XML10_LETTER+"_]["+XML_NC_NAME_CHAR+"]*";function xpathLog(){}function xsltLog(){}function xsltLogXml(){}var ajaxsltIsIE6=navigator.appVersion.match(/MSIE 6.0/);function assert(a){if(!a)throw"Assertion failed";}function stringSplit(a,b){var c=a.indexOf(b);if(c==-1)return[a];var d=[];for(d.push(a.substr(0,c));c!=-1;){var e=a.indexOf(b,c+1);e!=-1?d.push(a.substr(c+1,e-c-1)):d.push(a.substr(c+1));c=e}return d}
function xmlImportNode(a,b){if(b.nodeType==DOM_TEXT_NODE)return domCreateTextNode(a,b.nodeValue);else if(b.nodeType==DOM_CDATA_SECTION_NODE)return domCreateCDATASection(a,b.nodeValue);else if(b.nodeType==DOM_ELEMENT_NODE){for(var c=domCreateElement(a,b.nodeName),d=0;d<b.attributes.length;++d){var e=b.attributes[d];domSetAttribute(c,e.nodeName,e.nodeValue)}for(d=b.firstChild;d;d=d.nextSibling){e=arguments.callee(a,d);domAppendChild(c,e)}return c}else return domCreateComment(a,b.nodeName)}
function Set(){this.keys=[]}Set.prototype.size=function(){return this.keys.length};Set.prototype.add=function(a,b){var c=b||1;if(!this.contains(a)){this[":"+a]=c;this.keys.push(a)}};Set.prototype.set=function(a,b){var c=b||1;if(this.contains(a))this[":"+a]=c;else{this[":"+a]=c;this.keys.push(a)}};Set.prototype.inc=function(a){if(this.contains(a))this[":"+a]++;else{this[":"+a]=1;this.keys.push(a)}};Set.prototype.get=function(a){if(this.contains(a))return this[":"+a]};
Set.prototype.remove=function(a){if(this.contains(a)){delete this[":"+a];removeFromArray(this.keys,a,true)}};Set.prototype.contains=function(a){return typeof this[":"+a]!="undefined"};Set.prototype.items=function(){for(var a=[],b=0;b<this.keys.length;++b)a.push(this[":"+this.keys[b]]);return a};Set.prototype.map=function(a){for(var b=0;b<this.keys.length;++b){var c=this.keys[b];a.call(this,c,this[":"+c])}};
Set.prototype.clear=function(){for(var a=0;a<this.keys.length;++a)delete this[":"+this.keys[a]];this.keys.length=0};function mapExec(a,b){for(var c=0;c<a.length;++c)b.call(this,a[c],c)}function mapExpr(a,b){for(var c=[],d=0;d<a.length;++d)c.push(b(a[d]));return c}function reverseInplace(a){for(var b=0;b<a.length/2;++b){var c=a[b],d=a.length-b-1;a[b]=a[d];a[d]=c}}function removeFromArray(a,b,c){for(var d=0,e=0;e<a.length;++e)if(a[e]===b||c&&a[e]==b){a.splice(e--,1);d++}return d}
function copyArray(a,b){if(b)for(var c=a.length,d=b.length-1;d>=0;--d)a[d+c]=b[d]}function copyArrayIgnoringAttributesWithoutValue(a,b){if(b)for(var c=b.length-1;c>=0;--c)b[c].nodeValue&&a.push(b[c])}
function xmlValue(a,b){if(!a)return"";var c="";if(a.nodeType==DOM_TEXT_NODE||a.nodeType==DOM_CDATA_SECTION_NODE)c+=a.nodeValue;else if(a.nodeType==DOM_ATTRIBUTE_NODE)c+=ajaxsltIsIE6?xmlValueIE6Hack(a):a.nodeValue;else if(a.nodeType==DOM_ELEMENT_NODE||a.nodeType==DOM_DOCUMENT_NODE||a.nodeType==DOM_DOCUMENT_FRAGMENT_NODE){if(!b){var d=a.innerText;if(d!=undefined)return d;d=a.textContent;if(d!=undefined)return d}d=a.childNodes.length;for(var e=0;e<d;++e)c+=arguments.callee(a.childNodes[e])}return c}
function xmlValueIE6Hack(a){var b=a.nodeName;a=a.nodeValue;if(b.length!=4)return a;if(!/^href$/i.test(b))return a;if(!/^javascript:/.test(a))return a;return unescape(a)}function xmlText(a,b){var c=[];xmlTextR(a,c,b);return c.join("")}
function xmlTextR(a,b,c){if(a.nodeType==DOM_TEXT_NODE)b.push(xmlEscapeText(a.nodeValue));else if(a.nodeType==DOM_CDATA_SECTION_NODE)c?b.push(a.nodeValue):b.push("<![CDATA["+a.nodeValue+"]]\>");else if(a.nodeType==DOM_COMMENT_NODE)b.push("<!--"+a.nodeValue+"--\>");else if(a.nodeType==DOM_ELEMENT_NODE){b.push("<"+xmlFullNodeName(a));for(var d=0;d<a.attributes.length;++d){var e=a.attributes[d];e&&e.nodeName&&e.nodeValue&&b.push(" "+xmlFullNodeName(e)+'="'+xmlEscapeAttr(e.nodeValue)+'"')}if(a.childNodes.length==
0)b.push("/>");else{b.push(">");for(d=0;d<a.childNodes.length;++d)arguments.callee(a.childNodes[d],b,c);b.push("</"+xmlFullNodeName(a)+">")}}else if(a.nodeType==DOM_DOCUMENT_NODE||a.nodeType==DOM_DOCUMENT_FRAGMENT_NODE)for(d=0;d<a.childNodes.length;++d)arguments.callee(a.childNodes[d],b,c)}function xmlFullNodeName(a){return a.prefix&&a.nodeName.indexOf(a.prefix+":")!=0?a.prefix+":"+a.nodeName:a.nodeName}
function xmlEscapeText(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function xmlEscapeAttr(a){return xmlEscapeText(a).replace(/\"/g,"&quot;")}function xmlEscapeTags(a){return a.replace(/</g,"&lt;").replace(/>/g,"&gt;")}function xmlOwnerDocument(a){return a.nodeType==DOM_DOCUMENT_NODE?a:a.ownerDocument}function domGetAttribute(a,b){return a.getAttribute(b)}function domSetAttribute(a,b,c){return a.setAttribute(b,c)}
function domRemoveAttribute(a,b){return a.removeAttribute(b)}function domAppendChild(a,b){return a.appendChild(b)}function domRemoveChild(a,b){return a.removeChild(b)}function domReplaceChild(a,b,c){return a.replaceChild(b,c)}function domInsertBefore(a,b,c){return a.insertBefore(b,c)}function domRemoveNode(a){return domRemoveChild(a.parentNode,a)}function domCreateTextNode(a,b){return a.createTextNode(b)}function domCreateElement(a,b){return a.createElement(b)}
function domCreateAttribute(a,b){return a.createAttribute(b)}function domCreateCDATASection(a,b){return a.createCDATASection(b)}function domCreateComment(a,b){return a.createComment(b)}function domCreateDocumentFragment(a){return a.createDocumentFragment()}function domGetElementById(a,b){return a.getElementById(b)}function windowSetInterval(a,b,c){return a.setInterval(b,c)}function windowClearInterval(a,b){return a.clearInterval(b)}
RegExp.escape=function(){var a=RegExp("(\\/|\\.|\\*|\\+|\\?|\\||\\^|\\$|\\(|\\)|\\[|\\]|\\{|\\}|\\\\)","g");return function(b){return b.replace(a,"\\$1")}}();
function predicateExprHasPositionalSelector(a,b){if(!a)return false;if(!b&&exprReturnsNumberValue(a))return true;if(a instanceof FunctionCallExpr){var c=a.name.value;return c=="last"||c=="position"}if(a instanceof BinaryExpr)return predicateExprHasPositionalSelector(a.expr1,true)||predicateExprHasPositionalSelector(a.expr2,true);return false}
function exprReturnsNumberValue(a){if(a instanceof FunctionCallExpr){var b={last:true,position:true,count:true,"string-length":true,number:true,sum:true,floor:true,ceiling:true,round:true};return b[a.name.value]}else if(a instanceof UnaryMinusExpr)return true;else if(a instanceof BinaryExpr){b={"+":true,"-":true,"*":true,mod:true,div:true};return b[a.op.value]}else if(a instanceof NumberExpr)return true;return false}
function xmlResolveEntities(a){a=stringSplit(a,"&");for(var b=a[0],c=1;c<a.length;++c){var d=a[c].indexOf(";");if(d==-1)b+=a[c];else{var e=a[c].substring(0,d);d=a[c].substring(d+1);switch(e){case "lt":e="<";break;case "gt":e=">";break;case "amp":e="&";break;case "quot":e='"';break;case "apos":e="'";break;case "nbsp":e=String.fromCharCode(160);break;default:var f=domCreateElement(window.document,"span");f.innerHTML="&"+e+"; ";e=f.childNodes[0].nodeValue.charAt(0)}b+=e+d}}return b}
var XML10_TAGNAME_REGEXP=RegExp("^("+XML10_NAME+")"),XML10_ATTRIBUTE_REGEXP=RegExp(XML10_ATTRIBUTE,"g"),XML11_TAGNAME_REGEXP=RegExp("^("+XML11_NAME+")"),XML11_ATTRIBUTE_REGEXP=RegExp(XML11_ATTRIBUTE,"g");
function xmlParse(a){var b=/\/$/,c,d;if(a.match(/^<\?xml/))if(a.search(RegExp(XML10_VERSION_INFO))==5){c=XML10_TAGNAME_REGEXP;d=XML10_ATTRIBUTE_REGEXP}else if(a.search(RegExp(XML11_VERSION_INFO))==5){c=XML11_TAGNAME_REGEXP;d=XML11_ATTRIBUTE_REGEXP}else console.log("VersionInfo is missing, or unknown version number.");else{c=XML10_TAGNAME_REGEXP;d=XML10_ATTRIBUTE_REGEXP}var e=new XDocument,f=[],g=e;f.push(g);var k="";a=stringSplit(a,"<");for(var h=1;h<a.length;++h){var i=stringSplit(a[h],">"),j=i[0];
i=xmlResolveEntities(i[1]||"");if(k){j=a[h].indexOf(k);if(j!=-1){var m=a[h].substring(0,j);g.nodeValue+="<"+m;f.pop();g=f[f.length-1];i=a[h].substring(j+k.length);k=""}else{g.nodeValue+="<"+a[h];i=null}}else if(j.indexOf("![CDATA[")==0){m=8;j=a[h].indexOf("]]\>");if(j!=-1){m=a[h].substring(m,j);var l=domCreateCDATASection(e,m);domAppendChild(g,l)}else{m=a[h].substring(m);i=null;l=domCreateCDATASection(e,m);domAppendChild(g,l);g=l;f.push(l);k="]]\>"}}else if(j.indexOf("!--")==0){m=3;j=a[h].indexOf("--\>");
if(j!=-1){m=a[h].substring(m,j);l=domCreateComment(e,m);domAppendChild(g,l)}else{m=a[h].substring(m);i=null;l=domCreateComment(e,m);domAppendChild(g,l);g=l;f.push(l);k="--\>"}}else if(j.charAt(0)=="/"){f.pop();g=f[f.length-1]}else if(j.charAt(0)!="?")if(j.charAt(0)!="!"){m=j.match(b);l=c.exec(j)[1];l=domCreateElement(e,l);for(var n;n=d.exec(j);){var o=xmlResolveEntities(n[5]||n[7]||"");domSetAttribute(l,n[1],o)}domAppendChild(g,l);if(!m){g=l;f.push(l)}}i&&g!=e&&domAppendChild(g,domCreateTextNode(e,
i))}return e}var DOM_ELEMENT_NODE=1,DOM_ATTRIBUTE_NODE=2,DOM_TEXT_NODE=3,DOM_CDATA_SECTION_NODE=4,DOM_ENTITY_REFERENCE_NODE=5,DOM_ENTITY_NODE=6,DOM_PROCESSING_INSTRUCTION_NODE=7,DOM_COMMENT_NODE=8,DOM_DOCUMENT_NODE=9,DOM_DOCUMENT_TYPE_NODE=10,DOM_DOCUMENT_FRAGMENT_NODE=11,DOM_NOTATION_NODE=12;
function domTraverseElements(a,b,c){var d;if(b){d=b.call(null,a);if(typeof d=="boolean"&&!d)return false}for(var e=a.firstChild;e;e=e.nextSibling)if(e.nodeType==DOM_ELEMENT_NODE){d=arguments.callee.call(this,e,b,c);if(typeof d=="boolean"&&!d)return false}if(c){d=c.call(null,a);if(typeof d=="boolean"&&!d)return false}}function XNode(a,b,c,d){this.attributes=[];this.childNodes=[];XNode.init.call(this,a,b,c,d)}
XNode.init=function(a,b,c,d){this.nodeType=a-0;this.nodeName=""+b;this.nodeValue=""+c;this.ownerDocument=d;this.parentNode=this.previousSibling=this.nextSibling=this.lastChild=this.firstChild=null};XNode.unused_=[];
XNode.recycle=function(a){if(a)if(a.constructor==XDocument)XNode.recycle(a.documentElement);else if(a.constructor==this){XNode.unused_.push(a);for(var b=0;b<a.attributes.length;++b)XNode.recycle(a.attributes[b]);for(b=0;b<a.childNodes.length;++b)XNode.recycle(a.childNodes[b]);a.attributes.length=0;a.childNodes.length=0;XNode.init.call(a,0,"","",null)}};
XNode.create=function(a,b,c,d){if(XNode.unused_.length>0){var e=XNode.unused_.pop();XNode.init.call(e,a,b,c,d);return e}else return new XNode(a,b,c,d)};XNode.prototype.appendChild=function(a){if(this.childNodes.length==0)this.firstChild=a;a.previousSibling=this.lastChild;a.nextSibling=null;if(this.lastChild)this.lastChild.nextSibling=a;a.parentNode=this;this.lastChild=a;this.childNodes.push(a)};
XNode.prototype.replaceChild=function(a,b){if(b!=a)for(var c=0;c<this.childNodes.length;++c)if(this.childNodes[c]==b){this.childNodes[c]=a;c=b.parentNode;b.parentNode=null;a.parentNode=c;c=b.previousSibling;b.previousSibling=null;a.previousSibling=c;if(a.previousSibling)a.previousSibling.nextSibling=a;c=b.nextSibling;b.nextSibling=null;a.nextSibling=c;if(a.nextSibling)a.nextSibling.previousSibling=a;if(this.firstChild==b)this.firstChild=a;if(this.lastChild==b)this.lastChild=a;break}};
XNode.prototype.insertBefore=function(a,b){if(b!=a)if(b.parentNode==this){a.parentNode&&a.parentNode.removeChild(a);for(var c=[],d=0;d<this.childNodes.length;++d){var e=this.childNodes[d];if(e==b){c.push(a);a.parentNode=this;a.previousSibling=b.previousSibling;b.previousSibling=a;if(a.previousSibling)a.previousSibling.nextSibling=a;a.nextSibling=b;if(this.firstChild==b)this.firstChild=a}c.push(e)}this.childNodes=c}};
XNode.prototype.removeChild=function(a){for(var b=[],c=0;c<this.childNodes.length;++c){var d=this.childNodes[c];if(d!=a)b.push(d);else{if(d.previousSibling)d.previousSibling.nextSibling=d.nextSibling;if(d.nextSibling)d.nextSibling.previousSibling=d.previousSibling;if(this.firstChild==d)this.firstChild=d.nextSibling;if(this.lastChild==d)this.lastChild=d.previousSibling}}this.childNodes=b};XNode.prototype.hasAttributes=function(){return this.attributes.length>0};
XNode.prototype.setAttribute=function(a,b){for(var c=0;c<this.attributes.length;++c)if(this.attributes[c].nodeName==a){this.attributes[c].nodeValue=""+b;return}this.attributes.push(XNode.create(DOM_ATTRIBUTE_NODE,a,b,this))};XNode.prototype.getAttribute=function(a){for(var b=0;b<this.attributes.length;++b)if(this.attributes[b].nodeName==a)return this.attributes[b].nodeValue;return null};
XNode.prototype.removeAttribute=function(a){for(var b=[],c=0;c<this.attributes.length;++c)this.attributes[c].nodeName!=a&&b.push(this.attributes[c]);this.attributes=b};XNode.prototype.getElementsByTagName=function(a){var b=[],c=this;"*"==a?domTraverseElements(this,function(d){c!=d&&b.push(d)},null):domTraverseElements(this,function(d){c!=d&&d.nodeName==a&&b.push(d)},null);return b};
XNode.prototype.getElementById=function(a){var b=null;domTraverseElements(this,function(c){if(c.getAttribute("id")==a){b=c;return false}},null);return b};function XDocument(){XNode.call(this,DOM_DOCUMENT_NODE,"#document",null,null);this.documentElement=null}XDocument.prototype=new XNode(DOM_DOCUMENT_NODE,"#document");XDocument.prototype.clear=function(){XNode.recycle(this.documentElement);this.documentElement=null};
XDocument.prototype.appendChild=function(a){XNode.prototype.appendChild.call(this,a);this.documentElement=this.childNodes[0]};XDocument.prototype.createElement=function(a){return XNode.create(DOM_ELEMENT_NODE,a,null,this)};XDocument.prototype.createDocumentFragment=function(){return XNode.create(DOM_DOCUMENT_FRAGMENT_NODE,"#document-fragment",null,this)};XDocument.prototype.createTextNode=function(a){return XNode.create(DOM_TEXT_NODE,"#text",a,this)};
XDocument.prototype.createAttribute=function(a){return XNode.create(DOM_ATTRIBUTE_NODE,a,null,this)};XDocument.prototype.createComment=function(a){return XNode.create(DOM_COMMENT_NODE,"#comment",a,this)};XDocument.prototype.createCDATASection=function(a){return XNode.create(DOM_CDATA_SECTION_NODE,"#cdata-section",a,this)};
function xpathParse(a){xpathLog("parse "+a);xpathParseInit();var b=xpathCacheLookup(a);if(b){xpathLog(" ... cached");return b}if(a.match(/^(\$|@)?\w+$/i)){b=makeSimpleExpr(a);xpathParseCache[a]=b;xpathLog(" ... simple");return b}if(a.match(/^\w+(\/\w+)*$/i)){b=makeSimpleExpr2(a);xpathParseCache[a]=b;xpathLog(" ... simple 2");return b}b=a;for(var c=[],d=null,e=null,f=false,g=0,k=0,h=0;!f;){g++;a=a.replace(/^\s*/,"");e=d;for(var i=d=null,j="",m=0;m<xpathTokenRules.length;++m){var l=xpathTokenRules[m].re.exec(a);
k++;if(l&&l.length>0&&l[0].length>j.length){i=xpathTokenRules[m];j=l[0];break}}if(i&&(i==TOK_DIV||i==TOK_MOD||i==TOK_AND||i==TOK_OR)&&(!e||e.tag==TOK_AT||e.tag==TOK_DSLASH||e.tag==TOK_SLASH||e.tag==TOK_AXIS||e.tag==TOK_DOLLAR))i=TOK_QNAME;if(i){a=a.substr(j.length);xpathLog("token: "+j+" -- "+i.label);d={tag:i,match:j,prec:i.prec?i.prec:0,expr:makeTokenExpr(j)}}else{xpathLog("DONE");f=true}for(;xpathReduce(c,d);){h++;xpathLog("stack: "+stackToString(c))}}xpathLog("stack: "+stackToString(c));if(c.length!=
1)throw"XPath parse error "+b+":\n"+stackToString(c);l=c[0].expr;xpathParseCache[b]=l;xpathLog("XPath parse: "+g+" / "+k+" / "+h);return l}var xpathParseCache={};function xpathCacheLookup(a){return xpathParseCache[a]}
function xpathReduce(a,b){var c=null;if(a.length>0){var d=xpathRules[a[a.length-1].tag.key];if(d)for(var e=0;e<d.length;++e){var f=d[e],g=xpathMatchStack(a,f[1]);if(g.length){c={tag:f[0],rule:f,match:g};c.prec=xpathGrammarPrecedence(c);break}}}if(c&&(!b||c.prec>b.prec||b.tag.left&&c.prec>=b.prec)){for(e=0;e<c.match.matchlength;++e)a.pop();xpathLog("reduce "+c.tag.label+" "+c.prec+" ahead "+(b?b.tag.label+" "+b.prec+(b.tag.left?" left":""):" none "));d=mapExpr(c.match,function(k){return k.expr});xpathLog("going to apply "+
c.rule[3].toString());c.expr=c.rule[3].apply(null,d);a.push(c);c=true}else{if(b){xpathLog("shift "+b.tag.label+" "+b.prec+(b.tag.left?" left":"")+" over "+(c?c.tag.label+" "+c.prec:" none"));a.push(b)}c=false}return c}
function xpathMatchStack(a,b){var c=a.length,d=b.length,e=[],f=e.matchlength=0;d=d-1;for(c=c-1;d>=0&&c>=0;--d,c-=f){f=0;var g=[];if(b[d]==Q_MM){d-=1;for(e.push(g);c-f>=0&&a[c-f].tag==b[d];){g.push(a[c-f]);f+=1;e.matchlength+=1}}else if(b[d]==Q_01){d-=1;for(e.push(g);c-f>=0&&f<2&&a[c-f].tag==b[d];){g.push(a[c-f]);f+=1;e.matchlength+=1}}else if(b[d]==Q_1M){d-=1;e.push(g);if(a[c].tag==b[d])for(;c-f>=0&&a[c-f].tag==b[d];){g.push(a[c-f]);f+=1;e.matchlength+=1}else return[]}else if(a[c].tag==b[d]){e.push(a[c]);
f+=1;e.matchlength+=1}else return[];reverseInplace(g);g.expr=mapExpr(g,function(k){return k.expr})}reverseInplace(e);return d==-1?e:[]}function xpathTokenPrecedence(a){return a.prec||2}
function xpathGrammarPrecedence(a){var b=0;if(a.rule)if(a.rule.length>=3&&a.rule[2]>=0)b=a.rule[2];else for(var c=0;c<a.rule[1].length;++c){var d=xpathTokenPrecedence(a.rule[1][c]);b=Math.max(b,d)}else if(a.tag)b=xpathTokenPrecedence(a.tag);else if(a.length)for(c=0;c<a.length;++c){d=xpathGrammarPrecedence(a[c]);b=Math.max(b,d)}return b}function stackToString(a){for(var b="",c=0;c<a.length;++c){if(b)b+="\n";b+=a[c].tag.label}return b}
function ExprContext(a,b,c,d,e,f,g,k){this.node=a;this.position=b||0;this.nodelist=c||[a];this.variables={};this.parent=d||null;this.caseInsensitive=e||false;this.ignoreAttributesWithoutValue=f||false;this.returnOnFirstMatch=g||false;this.ignoreNonElementNodesForNTA=k||false;this.root=d?d.root:this.node.nodeType==DOM_DOCUMENT_NODE?a:a.ownerDocument}
ExprContext.prototype.clone=function(a,b,c){return new ExprContext(a||this.node,typeof b!="undefined"?b:this.position,c||this.nodelist,this,this.caseInsensitive,this.ignoreAttributesWithoutValue,this.returnOnFirstMatch,this.ignoreNonElementNodesForNTA)};
ExprContext.prototype.setVariable=function(a,b){this.variables[a]=b instanceof StringValue||b instanceof BooleanValue||b instanceof NumberValue||b instanceof NodeSetValue?b:"true"===b?new BooleanValue(true):"false"===b?new BooleanValue(false):TOK_NUMBER.re.test(b)?new NumberValue(b):new StringValue(b)};ExprContext.prototype.getVariable=function(a){return typeof this.variables[a]!="undefined"?this.variables[a]:this.parent?this.parent.getVariable(a):null};
ExprContext.prototype.setNode=function(a){this.node=this.nodelist[a];this.position=a};ExprContext.prototype.contextSize=function(){return this.nodelist.length};ExprContext.prototype.isCaseInsensitive=function(){return this.caseInsensitive};ExprContext.prototype.setCaseInsensitive=function(a){return this.caseInsensitive=a};ExprContext.prototype.isIgnoreAttributesWithoutValue=function(){return this.ignoreAttributesWithoutValue};
ExprContext.prototype.setIgnoreAttributesWithoutValue=function(a){return this.ignoreAttributesWithoutValue=a};ExprContext.prototype.isReturnOnFirstMatch=function(){return this.returnOnFirstMatch};ExprContext.prototype.setReturnOnFirstMatch=function(a){return this.returnOnFirstMatch=a};ExprContext.prototype.isIgnoreNonElementNodesForNTA=function(){return this.ignoreNonElementNodesForNTA};ExprContext.prototype.setIgnoreNonElementNodesForNTA=function(a){return this.ignoreNonElementNodesForNTA=a};
function StringValue(a){this.value=a;this.type="string"}StringValue.prototype.stringValue=function(){return this.value};StringValue.prototype.booleanValue=function(){return this.value.length>0};StringValue.prototype.numberValue=function(){return this.value-0};StringValue.prototype.nodeSetValue=function(){throw this;};function BooleanValue(a){this.value=a;this.type="boolean"}BooleanValue.prototype.stringValue=function(){return""+this.value};BooleanValue.prototype.booleanValue=function(){return this.value};
BooleanValue.prototype.numberValue=function(){return this.value?1:0};BooleanValue.prototype.nodeSetValue=function(){throw this;};function NumberValue(a){this.value=a;this.type="number"}NumberValue.prototype.stringValue=function(){return""+this.value};NumberValue.prototype.booleanValue=function(){return!!this.value};NumberValue.prototype.numberValue=function(){return this.value-0};NumberValue.prototype.nodeSetValue=function(){throw this;};
function NodeSetValue(a){this.value=a;this.type="node-set"}NodeSetValue.prototype.stringValue=function(){return this.value.length==0?"":xmlValue(this.value[0])};NodeSetValue.prototype.booleanValue=function(){return this.value.length>0};NodeSetValue.prototype.numberValue=function(){return this.stringValue()-0};NodeSetValue.prototype.nodeSetValue=function(){return this.value};function TokenExpr(a){this.value=a}TokenExpr.prototype.evaluate=function(){return new StringValue(this.value)};
function LocationExpr(){this.absolute=false;this.steps=[]}LocationExpr.prototype.appendStep=function(a){var b=this._combineSteps(this.steps[this.steps.length-1],a);if(b)this.steps[this.steps.length-1]=b;else this.steps.push(a)};LocationExpr.prototype.prependStep=function(a){var b=this._combineSteps(a,this.steps[0]);if(b)this.steps[0]=b;else this.steps.unshift(a)};
LocationExpr.prototype._combineSteps=function(a,b){if(!a)return null;if(!b)return null;var c=a.predicates&&a.predicates.length>0;if(a.nodetest instanceof NodeTestAny&&!c)if(a.axis==xpathAxis.DESCENDANT_OR_SELF){if(b.axis!=xpathAxis.CHILD)if(b.axis==xpathAxis.SELF){b.axis=xpathAxis.DESCENDANT_OR_SELF;return b}}else if(a.axis==xpathAxis.DESCENDANT)if(b.axis==xpathAxis.SELF){b.axis=xpathAxis.DESCENDANT;return b}return null};
LocationExpr.prototype.evaluate=function(a){var b=[];xPathStep(b,this.steps,0,this.absolute?a.root:a.node,a);return new NodeSetValue(b)};
function xPathStep(a,b,c,d,e){var f=b[c];d=e.clone(d);if(e.returnOnFirstMatch&&!f.hasPositionalPredicate){d=f.evaluate(d).nodeSetValue();var g=d.length,k=f.predicate.length,h=0;a:for(;h<g;++h){for(var i=d[h],j=0;j<k;++j)if(!f.predicate[j].evaluate(e.clone(i,h,d)).booleanValue())continue a;c==b.length-1?a.push(i):xPathStep(a,b,c+1,i,e);if(a.length>0)break}}else{d.returnOnFirstMatch=false;d=f.evaluate(d).nodeSetValue();for(h=0;h<d.length;++h)c==b.length-1?a.push(d[h]):xPathStep(a,b,c+1,d[h],e)}}
function StepExpr(a,b,c){this.axis=a;this.nodetest=b;this.predicate=c||[];this.hasPositionalPredicate=false;for(a=0;a<this.predicate.length;++a)if(predicateExprHasPositionalSelector(this.predicate[a].expr)){this.hasPositionalPredicate=true;break}}StepExpr.prototype.appendPredicate=function(a){this.predicate.push(a);if(!this.hasPositionalPredicate)this.hasPositionalPredicate=predicateExprHasPositionalSelector(a.expr)};
StepExpr.prototype.evaluate=function(a){var b=a.node,c=[],d=false;if(this.nodetest instanceof NodeTestAny)d=true;if(this.axis==xpathAxis.ANCESTOR_OR_SELF){c.push(b);for(b=b.parentNode;b;b=b.parentNode)c.push(b)}else if(this.axis==xpathAxis.ANCESTOR)for(b=b.parentNode;b;b=b.parentNode)c.push(b);else if(this.axis==xpathAxis.ATTRIBUTE)if(this.nodetest.name!=undefined){if(b.attributes)if(b.attributes instanceof Array)copyArray(c,b.attributes);else if(this.nodetest.name=="style"){var e=b.getAttribute("style");
e&&typeof e!="string"?c.push(XNode.create(DOM_ATTRIBUTE_NODE,"style",e.cssText,document)):c.push(b.attributes[this.nodetest.name])}else c.push(b.attributes[this.nodetest.name])}else a.ignoreAttributesWithoutValue?copyArrayIgnoringAttributesWithoutValue(c,b.attributes):copyArray(c,b.attributes);else if(this.axis==xpathAxis.CHILD)copyArray(c,b.childNodes);else if(this.axis==xpathAxis.DESCENDANT_OR_SELF){this.nodetest.evaluate(a).booleanValue()&&c.push(b);e=xpathExtractTagNameFromNodeTest(this.nodetest,
a.ignoreNonElementNodesForNTA);xpathCollectDescendants(c,b,e);if(e)d=true}else if(this.axis==xpathAxis.DESCENDANT){e=xpathExtractTagNameFromNodeTest(this.nodetest,a.ignoreNonElementNodesForNTA);xpathCollectDescendants(c,b,e);if(e)d=true}else if(this.axis==xpathAxis.FOLLOWING)for(b=b;b;b=b.parentNode)for(e=b.nextSibling;e;e=e.nextSibling){c.push(e);xpathCollectDescendants(c,e)}else if(this.axis==xpathAxis.FOLLOWING_SIBLING)for(b=b.nextSibling;b;b=b.nextSibling)c.push(b);else if(this.axis==xpathAxis.NAMESPACE)console.log("not implemented: axis namespace");
else if(this.axis==xpathAxis.PARENT)b.parentNode&&c.push(b.parentNode);else if(this.axis==xpathAxis.PRECEDING)for(b=b;b;b=b.parentNode)for(e=b.previousSibling;e;e=e.previousSibling){c.push(e);xpathCollectDescendantsReverse(c,e)}else if(this.axis==xpathAxis.PRECEDING_SIBLING)for(b=b.previousSibling;b;b=b.previousSibling)c.push(b);else if(this.axis==xpathAxis.SELF)c.push(b);else throw"ERROR -- NO SUCH AXIS: "+this.axis;if(!d){d=c;c=[];for(e=0;e<d.length;++e){b=d[e];this.nodetest.evaluate(a.clone(b,
e,d)).booleanValue()&&c.push(b)}}if(!a.returnOnFirstMatch)for(e=0;e<this.predicate.length;++e){d=c;c=[];for(var f=0;f<d.length;++f){b=d[f];this.predicate[e].evaluate(a.clone(b,f,d)).booleanValue()&&c.push(b)}}return new NodeSetValue(c)};function NodeTestAny(){this.value=new BooleanValue(true)}NodeTestAny.prototype.evaluate=function(){return this.value};function NodeTestElementOrAttribute(){}
NodeTestElementOrAttribute.prototype.evaluate=function(a){return new BooleanValue(a.node.nodeType==DOM_ELEMENT_NODE||a.node.nodeType==DOM_ATTRIBUTE_NODE)};function NodeTestText(){}NodeTestText.prototype.evaluate=function(a){return new BooleanValue(a.node.nodeType==DOM_TEXT_NODE)};function NodeTestComment(){}NodeTestComment.prototype.evaluate=function(a){return new BooleanValue(a.node.nodeType==DOM_COMMENT_NODE)};function NodeTestPI(a){this.target=a}
NodeTestPI.prototype.evaluate=function(a){return new BooleanValue(a.node.nodeType==DOM_PROCESSING_INSTRUCTION_NODE&&(!this.target||a.node.nodeName==this.target))};function NodeTestNC(a){this.regex=RegExp("^"+a+":");this.nsprefix=a}NodeTestNC.prototype.evaluate=function(a){return new BooleanValue(this.regex.match(a.node.nodeName))};function NodeTestName(a){this.name=a;this.re=RegExp("^"+a+"$","i")}
NodeTestName.prototype.evaluate=function(a){var b=a.node;if(a.caseInsensitive){if(b.nodeName.length!=this.name.length)return new BooleanValue(false);return new BooleanValue(this.re.test(b.nodeName))}else return new BooleanValue(b.nodeName==this.name)};function PredicateExpr(a){this.expr=a}PredicateExpr.prototype.evaluate=function(a){var b=this.expr.evaluate(a);return b.type=="number"?new BooleanValue(a.position==b.numberValue()-1):new BooleanValue(b.booleanValue())};
function FunctionCallExpr(a){this.name=a;this.args=[]}FunctionCallExpr.prototype.appendArg=function(a){this.args.push(a)};FunctionCallExpr.prototype.evaluate=function(a){var b=""+this.name.value,c=this.xpathfunctions[b];if(c)return c.call(this,a);else{xpathLog("XPath NO SUCH FUNCTION "+b);return new BooleanValue(false)}};
FunctionCallExpr.prototype.xpathfunctions={last:function(a){assert(this.args.length==0);return new NumberValue(a.contextSize())},position:function(a){assert(this.args.length==0);return new NumberValue(a.position+1)},count:function(a){assert(this.args.length==1);a=this.args[0].evaluate(a);return new NumberValue(a.nodeSetValue().length)},id:function(a){assert(this.args.length==1);var b=this.args[0].evaluate(a),c=[],d;if(b.type=="node-set"){d=[];var e=b.nodeSetValue();for(b=0;b<e.length;++b)for(var f=
xmlValue(e[b]).split(/\s+/),g=0;g<f.length;++g)d.push(f[g])}else d=b.stringValue().split(/\s+/);a=a.root;for(b=0;b<d.length;++b)(e=a.getElementById(d[b]))&&c.push(e);return new NodeSetValue(c)},"local-name":function(){console.log("not implmented yet: XPath function local-name()")},"namespace-uri":function(){console.log("not implmented yet: XPath function namespace-uri()")},name:function(a){assert(this.args.length==1||this.args.length==0);a=this.args.length==0?[a.node]:this.args[0].evaluate(a).nodeSetValue();
return a.length==0?new StringValue(""):new StringValue(a[0].nodeName)},string:function(a){assert(this.args.length==1||this.args.length==0);return this.args.length==0?new StringValue((new NodeSetValue([a.node])).stringValue()):new StringValue(this.args[0].evaluate(a).stringValue())},concat:function(a){for(var b="",c=0;c<this.args.length;++c)b+=this.args[c].evaluate(a).stringValue();return new StringValue(b)},"starts-with":function(a){assert(this.args.length==2);var b=this.args[0].evaluate(a).stringValue();
a=this.args[1].evaluate(a).stringValue();return new BooleanValue(b.indexOf(a)==0)},"ends-with":function(a){assert(this.args.length==2);var b=this.args[0].evaluate(a).stringValue();a=this.args[1].evaluate(a).stringValue();a=RegExp(RegExp.escape(a)+"$");return new BooleanValue(a.test(b))},contains:function(a){assert(this.args.length==2);var b=this.args[0].evaluate(a).stringValue();a=this.args[1].evaluate(a).stringValue();return new BooleanValue(b.indexOf(a)!=-1)},"substring-before":function(a){assert(this.args.length==
2);var b=this.args[0].evaluate(a).stringValue();a=this.args[1].evaluate(a).stringValue();a=b.indexOf(a);b=a==-1?"":b.substr(0,a);return new StringValue(b)},"substring-after":function(a){assert(this.args.length==2);var b=this.args[0].evaluate(a).stringValue();a=this.args[1].evaluate(a).stringValue();var c=b.indexOf(a);b=c==-1?"":b.substr(c+a.length);return new StringValue(b)},substring:function(a){assert(this.args.length==2||this.args.length==3);var b=this.args[0].evaluate(a).stringValue(),c=this.args[1].evaluate(a).numberValue();
if(this.args.length==2){c=Math.max(0,Math.round(c)-1);b=b.substr(c)}else{a=this.args[2].evaluate(a).numberValue();var d=Math.round(c)-1;c=Math.max(0,d);b=b.substr(c,Math.round(a)-Math.max(0,-d))}return new StringValue(b)},"string-length":function(a){a=this.args.length>0?this.args[0].evaluate(a).stringValue():(new NodeSetValue([a.node])).stringValue();return new NumberValue(a.length)},"normalize-space":function(a){a=this.args.length>0?this.args[0].evaluate(a).stringValue():(new NodeSetValue([a.node])).stringValue();
a=a.replace(/^\s*/,"").replace(/\s*$/,"").replace(/\s+/g," ");return new StringValue(a)},translate:function(a){assert(this.args.length==3);var b=this.args[0].evaluate(a).stringValue(),c=this.args[1].evaluate(a).stringValue();a=this.args[2].evaluate(a).stringValue();for(var d=0;d<c.length;++d)b=b.replace(RegExp(c.charAt(d),"g"),a.charAt(d));return new StringValue(b)},matches:function(a){assert(this.args.length>=2);var b=this.args[0].evaluate(a).stringValue(),c=this.args[1].evaluate(a).stringValue();
if(this.args.length>2){var d=this.args[2].evaluate(a).stringValue();if(/[^mi]/.test(d))throw"Invalid regular expression syntax: "+d;}try{var e=RegExp(c,d)}catch(f){throw"Invalid matches argument: "+c;}return new BooleanValue(e.test(b))},"boolean":function(a){assert(this.args.length==1);return new BooleanValue(this.args[0].evaluate(a).booleanValue())},not:function(a){assert(this.args.length==1);a=!this.args[0].evaluate(a).booleanValue();return new BooleanValue(a)},"true":function(){assert(this.args.length==
0);return new BooleanValue(true)},"false":function(){assert(this.args.length==0);return new BooleanValue(false)},lang:function(a){assert(this.args.length==1);var b=this.args[0].evaluate(a).stringValue(),c;for(a=a.node;a&&a!=a.parentNode;){if(c=a.getAttribute("xml:lang"))break;a=a.parentNode}if(c){b=RegExp("^"+b+"$","i");return new BooleanValue(c.match(b)||c.replace(/_.*$/,"").match(b))}else return new BooleanValue(false)},number:function(a){assert(this.args.length==1||this.args.length==0);return this.args.length==
1?new NumberValue(this.args[0].evaluate(a).numberValue()):new NumberValue((new NodeSetValue([a.node])).numberValue())},sum:function(a){assert(this.args.length==1);a=this.args[0].evaluate(a).nodeSetValue();for(var b=0,c=0;c<a.length;++c)b+=xmlValue(a[c])-0;return new NumberValue(b)},floor:function(a){assert(this.args.length==1);a=this.args[0].evaluate(a).numberValue();return new NumberValue(Math.floor(a))},ceiling:function(a){assert(this.args.length==1);a=this.args[0].evaluate(a).numberValue();return new NumberValue(Math.ceil(a))},
round:function(a){assert(this.args.length==1);a=this.args[0].evaluate(a).numberValue();return new NumberValue(Math.round(a))},"ext-join":function(a){assert(this.args.length==2);var b=this.args[0].evaluate(a).nodeSetValue();a=this.args[1].evaluate(a).stringValue();for(var c="",d=0;d<b.length;++d){if(c)c+=a;c+=xmlValue(b[d])}return new StringValue(c)},"ext-if":function(a){assert(this.args.length==3);return this.args[0].evaluate(a).booleanValue()?this.args[1].evaluate(a):this.args[2].evaluate(a)},"ext-cardinal":function(a){assert(this.args.length>=
1);for(var b=this.args[0].evaluate(a).numberValue(),c=[],d=0;d<b;++d)c.push(a.node);return new NodeSetValue(c)}};function UnionExpr(a,b){this.expr1=a;this.expr2=b}UnionExpr.prototype.evaluate=function(a){var b=this.expr1.evaluate(a).nodeSetValue();a=this.expr2.evaluate(a).nodeSetValue();for(var c=b.length,d=0;d<a.length;++d){for(var e=a[d],f=false,g=0;g<c;++g)if(b[g]==e){f=true;g=c}f||b.push(e)}return new NodeSetValue(b)};function PathExpr(a,b){this.filter=a;this.rel=b}
PathExpr.prototype.evaluate=function(a){var b=this.filter.evaluate(a).nodeSetValue(),c=[];if(a.returnOnFirstMatch)for(var d=0;d<b.length;++d){c=this.rel.evaluate(a.clone(b[d],d,b)).nodeSetValue();if(c.length>0)break}else for(d=0;d<b.length;++d)for(var e=this.rel.evaluate(a.clone(b[d],d,b)).nodeSetValue(),f=0;f<e.length;++f)c.push(e[f]);return new NodeSetValue(c)};function FilterExpr(a,b){this.expr=a;this.predicate=b}
FilterExpr.prototype.evaluate=function(a){var b=a.returnOnFirstMatch;a.setReturnOnFirstMatch(false);var c=this.expr.evaluate(a).nodeSetValue();a.setReturnOnFirstMatch(b);for(b=0;b<this.predicate.length;++b){var d=c;c=[];for(var e=0;e<d.length;++e){var f=d[e];this.predicate[b].evaluate(a.clone(f,e,d)).booleanValue()&&c.push(f)}}return new NodeSetValue(c)};function UnaryMinusExpr(a){this.expr=a}UnaryMinusExpr.prototype.evaluate=function(a){return new NumberValue(-this.expr.evaluate(a).numberValue())};
function BinaryExpr(a,b,c){this.expr1=a;this.expr2=c;this.op=b}
BinaryExpr.prototype.evaluate=function(a){var b;switch(this.op.value){case "or":b=new BooleanValue(this.expr1.evaluate(a).booleanValue()||this.expr2.evaluate(a).booleanValue());break;case "and":b=new BooleanValue(this.expr1.evaluate(a).booleanValue()&&this.expr2.evaluate(a).booleanValue());break;case "+":b=new NumberValue(this.expr1.evaluate(a).numberValue()+this.expr2.evaluate(a).numberValue());break;case "-":b=new NumberValue(this.expr1.evaluate(a).numberValue()-this.expr2.evaluate(a).numberValue());
break;case "*":b=new NumberValue(this.expr1.evaluate(a).numberValue()*this.expr2.evaluate(a).numberValue());break;case "mod":b=new NumberValue(this.expr1.evaluate(a).numberValue()%this.expr2.evaluate(a).numberValue());break;case "div":b=new NumberValue(this.expr1.evaluate(a).numberValue()/this.expr2.evaluate(a).numberValue());break;case "=":b=this.compare(a,function(c,d){return c==d});break;case "!=":b=this.compare(a,function(c,d){return c!=d});break;case "<":b=this.compare(a,function(c,d){return c<
d});break;case "<=":b=this.compare(a,function(c,d){return c<=d});break;case ">":b=this.compare(a,function(c,d){return c>d});break;case ">=":b=this.compare(a,function(c,d){return c>=d});break;default:console.log("BinaryExpr.evaluate: "+this.op.value)}return b};
BinaryExpr.prototype.compare=function(a,b){var c=this.expr1.evaluate(a),d=this.expr2.evaluate(a);if(c.type=="node-set"&&d.type=="node-set"){c=c.nodeSetValue();var e=d.nodeSetValue();d=false;for(var f=0;f<c.length;++f)for(var g=0;g<e.length;++g)if(b(xmlValue(c[f]),xmlValue(e[g]))){d=true;g=e.length;f=c.length}}else if(c.type=="node-set"||d.type=="node-set")if(c.type=="number"){c=c.numberValue();e=d.nodeSetValue();d=false;for(f=0;f<e.length;++f){g=xmlValue(e[f])-0;if(b(c,g)){d=true;break}}}else if(d.type==
"number"){e=c.nodeSetValue();c=d.numberValue();d=false;for(f=0;f<e.length;++f){g=xmlValue(e[f])-0;if(b(g,c)){d=true;break}}}else if(c.type=="string"){c=c.stringValue();e=d.nodeSetValue();d=false;for(f=0;f<e.length;++f){g=xmlValue(e[f]);if(b(c,g)){d=true;break}}}else if(d.type=="string"){e=c.nodeSetValue();c=d.stringValue();d=false;for(f=0;f<e.length;++f){g=xmlValue(e[f]);if(b(g,c)){d=true;break}}}else d=b(c.booleanValue(),d.booleanValue());else d=c.type=="boolean"||d.type=="boolean"?b(c.booleanValue(),
d.booleanValue()):c.type=="number"||d.type=="number"?b(c.numberValue(),d.numberValue()):b(c.stringValue(),d.stringValue());return new BooleanValue(d)};function LiteralExpr(a){this.value=a}LiteralExpr.prototype.evaluate=function(){return new StringValue(this.value)};function NumberExpr(a){this.value=a}NumberExpr.prototype.evaluate=function(){return new NumberValue(this.value)};function VariableExpr(a){this.name=a}VariableExpr.prototype.evaluate=function(a){return a.getVariable(this.name)};
function makeTokenExpr(a){return new TokenExpr(a)}function passExpr(a){return a}function makeLocationExpr1(a,b){b.absolute=true;return b}function makeLocationExpr2(a,b){b.absolute=true;b.prependStep(makeAbbrevStep(a.value));return b}function makeLocationExpr3(){var a=new LocationExpr;a.appendStep(makeAbbrevStep("."));a.absolute=true;return a}function makeLocationExpr4(a){var b=new LocationExpr;b.absolute=true;b.appendStep(makeAbbrevStep(a.value));return b}
function makeLocationExpr5(a){var b=new LocationExpr;b.appendStep(a);return b}function makeLocationExpr6(a,b,c){a.appendStep(c);return a}function makeLocationExpr7(a,b,c){a.appendStep(makeAbbrevStep(b.value));a.appendStep(c);return a}function makeStepExpr1(a){return makeAbbrevStep(a.value)}function makeStepExpr2(a){return makeAbbrevStep(a.value)}function makeStepExpr3(a,b,c){return new StepExpr(a.value,c)}function makeStepExpr4(a,b){return new StepExpr("attribute",b)}
function makeStepExpr5(a){return new StepExpr("child",a)}function makeStepExpr6(a,b){a.appendPredicate(b);return a}function makeAbbrevStep(a){switch(a){case "//":return new StepExpr("descendant-or-self",new NodeTestAny);case ".":return new StepExpr("self",new NodeTestAny);case "..":return new StepExpr("parent",new NodeTestAny)}}function makeNodeTestExpr1(){return new NodeTestElementOrAttribute}function makeNodeTestExpr2(a){return new NodeTestNC(a.value)}
function makeNodeTestExpr3(a){return new NodeTestName(a.value)}function makeNodeTestExpr4(a){switch(a.value.replace(/\s*\($/,"")){case "node":return new NodeTestAny;case "text":return new NodeTestText;case "comment":return new NodeTestComment;case "processing-instruction":return new NodeTestPI("")}}function makeNodeTestExpr5(a,b){var c=a.replace(/\s*\($/,"");if(c!="processing-instruction")throw c;return new NodeTestPI(b.value)}function makePredicateExpr(a,b){return new PredicateExpr(b)}
function makePrimaryExpr(a,b){return b}function makeFunctionCallExpr1(a){return new FunctionCallExpr(a)}function makeFunctionCallExpr2(a,b,c,d){a=new FunctionCallExpr(a);a.appendArg(c);for(c=0;c<d.length;++c)a.appendArg(d[c]);return a}function makeArgumentExpr(a,b){return b}function makeUnionExpr(a,b,c){return new UnionExpr(a,c)}function makePathExpr1(a,b,c){return new PathExpr(a,c)}function makePathExpr2(a,b,c){c.prependStep(makeAbbrevStep(b.value));return new PathExpr(a,c)}
function makeFilterExpr(a,b){return b.length>0?new FilterExpr(a,b):a}function makeUnaryMinusExpr(a,b){return new UnaryMinusExpr(b)}function makeBinaryExpr(a,b,c){return new BinaryExpr(a,b,c)}function makeLiteralExpr(a){a=a.value.substring(1,a.value.length-1);return new LiteralExpr(a)}function makeNumberExpr(a){return new NumberExpr(a.value)}function makeVariableReference(a,b){return new VariableExpr(b.value)}
function makeSimpleExpr(a){if(a.charAt(0)=="$")return new VariableExpr(a.substr(1));else if(a.charAt(0)=="@"){a=new NodeTestName(a.substr(1));a=new StepExpr("attribute",a);var b=new LocationExpr;b.appendStep(a);return b}else if(a.match(/^[0-9]+$/))return new NumberExpr(a);else{a=new NodeTestName(a);a=new StepExpr("child",a);b=new LocationExpr;b.appendStep(a);return b}}
function makeSimpleExpr2(a){a=stringSplit(a,"/");for(var b=new LocationExpr,c=0;c<a.length;++c){var d=new NodeTestName(a[c]);d=new StepExpr("child",d);b.appendStep(d)}return b}
var xpathAxis={ANCESTOR_OR_SELF:"ancestor-or-self",ANCESTOR:"ancestor",ATTRIBUTE:"attribute",CHILD:"child",DESCENDANT_OR_SELF:"descendant-or-self",DESCENDANT:"descendant",FOLLOWING_SIBLING:"following-sibling",FOLLOWING:"following",NAMESPACE:"namespace",PARENT:"parent",PRECEDING_SIBLING:"preceding-sibling",PRECEDING:"preceding",SELF:"self"},xpathAxesRe=[xpathAxis.ANCESTOR_OR_SELF,xpathAxis.ANCESTOR,xpathAxis.ATTRIBUTE,xpathAxis.CHILD,xpathAxis.DESCENDANT_OR_SELF,xpathAxis.DESCENDANT,xpathAxis.FOLLOWING_SIBLING,
xpathAxis.FOLLOWING,xpathAxis.NAMESPACE,xpathAxis.PARENT,xpathAxis.PRECEDING_SIBLING,xpathAxis.PRECEDING,xpathAxis.SELF].join("|"),TOK_PIPE={label:"|",prec:17,re:/^\|/},TOK_DSLASH={label:"//",prec:19,re:/^\/\//},TOK_SLASH={label:"/",prec:30,re:/^\//},TOK_AXIS={label:"::",prec:20,re:/^::/},TOK_COLON={label:":",prec:1E3,re:/^:/},TOK_AXISNAME={label:"[axis]",re:RegExp("^("+xpathAxesRe+")")},TOK_PARENO={label:"(",prec:34,re:/^\(/},TOK_PARENC={label:")",re:/^\)/},TOK_DDOT={label:"..",prec:34,re:/^\.\./},
TOK_DOT={label:".",prec:34,re:/^\./},TOK_AT={label:"@",prec:34,re:/^@/},TOK_COMMA={label:",",re:/^,/},TOK_OR={label:"or",prec:10,re:/^or\b/},TOK_AND={label:"and",prec:11,re:/^and\b/},TOK_EQ={label:"=",prec:12,re:/^=/},TOK_NEQ={label:"!=",prec:12,re:/^!=/},TOK_GE={label:">=",prec:13,re:/^>=/},TOK_GT={label:">",prec:13,re:/^>/},TOK_LE={label:"<=",prec:13,re:/^<=/},TOK_LT={label:"<",prec:13,re:/^</},TOK_PLUS={label:"+",prec:14,re:/^\+/,left:true},TOK_MINUS={label:"-",prec:14,re:/^\-/,left:true},TOK_DIV=
{label:"div",prec:15,re:/^div\b/,left:true},TOK_MOD={label:"mod",prec:15,re:/^mod\b/,left:true},TOK_BRACKO={label:"[",prec:32,re:/^\[/},TOK_BRACKC={label:"]",re:/^\]/},TOK_DOLLAR={label:"$",re:/^\$/},TOK_NCNAME={label:"[ncname]",re:RegExp("^"+XML_NC_NAME)},TOK_ASTERISK={label:"*",prec:15,re:/^\*/,left:true},TOK_LITERALQ={label:"[litq]",prec:20,re:/^'[^\']*'/},TOK_LITERALQQ={label:"[litqq]",prec:20,re:/^"[^\"]*"/},TOK_NUMBER={label:"[number]",prec:35,re:/^\d+(\.\d*)?/},TOK_QNAME={label:"[qname]",re:RegExp("^("+
XML_NC_NAME+":)?"+XML_NC_NAME)},TOK_NODEO={label:"[nodetest-start]",re:/^(processing-instruction|comment|text|node)\(/},xpathTokenRules=[TOK_DSLASH,TOK_SLASH,TOK_DDOT,TOK_DOT,TOK_AXIS,TOK_COLON,TOK_AXISNAME,TOK_NODEO,TOK_PARENO,TOK_PARENC,TOK_BRACKO,TOK_BRACKC,TOK_AT,TOK_COMMA,TOK_OR,TOK_AND,TOK_NEQ,TOK_EQ,TOK_GE,TOK_GT,TOK_LE,TOK_LT,TOK_PLUS,TOK_MINUS,TOK_ASTERISK,TOK_PIPE,TOK_MOD,TOK_DIV,TOK_LITERALQ,TOK_LITERALQQ,TOK_NUMBER,TOK_QNAME,TOK_NCNAME,TOK_DOLLAR],XPathLocationPath={label:"LocationPath"},
XPathRelativeLocationPath={label:"RelativeLocationPath"},XPathAbsoluteLocationPath={label:"AbsoluteLocationPath"},XPathStep={label:"Step"},XPathNodeTest={label:"NodeTest"},XPathPredicate={label:"Predicate"},XPathLiteral={label:"Literal"},XPathExpr={label:"Expr"},XPathPrimaryExpr={label:"PrimaryExpr"},XPathVariableReference={label:"Variablereference"},XPathNumber={label:"Number"},XPathFunctionCall={label:"FunctionCall"},XPathArgumentRemainder={label:"ArgumentRemainder"},XPathPathExpr={label:"PathExpr"},
XPathUnionExpr={label:"UnionExpr"},XPathFilterExpr={label:"FilterExpr"},XPathDigits={label:"Digits"},xpathNonTerminals=[XPathLocationPath,XPathRelativeLocationPath,XPathAbsoluteLocationPath,XPathStep,XPathNodeTest,XPathPredicate,XPathLiteral,XPathExpr,XPathPrimaryExpr,XPathVariableReference,XPathNumber,XPathFunctionCall,XPathArgumentRemainder,XPathPathExpr,XPathUnionExpr,XPathFilterExpr,XPathDigits],Q_01={label:"?"},Q_MM={label:"*"},Q_1M={label:"+"},ASSOC_LEFT=true,xpathGrammarRules=[[XPathLocationPath,
[XPathRelativeLocationPath],18,passExpr],[XPathLocationPath,[XPathAbsoluteLocationPath],18,passExpr],[XPathAbsoluteLocationPath,[TOK_SLASH,XPathRelativeLocationPath],18,makeLocationExpr1],[XPathAbsoluteLocationPath,[TOK_DSLASH,XPathRelativeLocationPath],18,makeLocationExpr2],[XPathAbsoluteLocationPath,[TOK_SLASH],0,makeLocationExpr3],[XPathAbsoluteLocationPath,[TOK_DSLASH],0,makeLocationExpr4],[XPathRelativeLocationPath,[XPathStep],31,makeLocationExpr5],[XPathRelativeLocationPath,[XPathRelativeLocationPath,
TOK_SLASH,XPathStep],31,makeLocationExpr6],[XPathRelativeLocationPath,[XPathRelativeLocationPath,TOK_DSLASH,XPathStep],31,makeLocationExpr7],[XPathStep,[TOK_DOT],33,makeStepExpr1],[XPathStep,[TOK_DDOT],33,makeStepExpr2],[XPathStep,[TOK_AXISNAME,TOK_AXIS,XPathNodeTest],33,makeStepExpr3],[XPathStep,[TOK_AT,XPathNodeTest],33,makeStepExpr4],[XPathStep,[XPathNodeTest],33,makeStepExpr5],[XPathStep,[XPathStep,XPathPredicate],33,makeStepExpr6],[XPathNodeTest,[TOK_ASTERISK],33,makeNodeTestExpr1],[XPathNodeTest,
[TOK_NCNAME,TOK_COLON,TOK_ASTERISK],33,makeNodeTestExpr2],[XPathNodeTest,[TOK_QNAME],33,makeNodeTestExpr3],[XPathNodeTest,[TOK_NODEO,TOK_PARENC],33,makeNodeTestExpr4],[XPathNodeTest,[TOK_NODEO,XPathLiteral,TOK_PARENC],33,makeNodeTestExpr5],[XPathPredicate,[TOK_BRACKO,XPathExpr,TOK_BRACKC],33,makePredicateExpr],[XPathPrimaryExpr,[XPathVariableReference],33,passExpr],[XPathPrimaryExpr,[TOK_PARENO,XPathExpr,TOK_PARENC],33,makePrimaryExpr],[XPathPrimaryExpr,[XPathLiteral],30,passExpr],[XPathPrimaryExpr,
[XPathNumber],30,passExpr],[XPathPrimaryExpr,[XPathFunctionCall],31,passExpr],[XPathFunctionCall,[TOK_QNAME,TOK_PARENO,TOK_PARENC],-1,makeFunctionCallExpr1],[XPathFunctionCall,[TOK_QNAME,TOK_PARENO,XPathExpr,XPathArgumentRemainder,Q_MM,TOK_PARENC],-1,makeFunctionCallExpr2],[XPathArgumentRemainder,[TOK_COMMA,XPathExpr],-1,makeArgumentExpr],[XPathUnionExpr,[XPathPathExpr],20,passExpr],[XPathUnionExpr,[XPathUnionExpr,TOK_PIPE,XPathPathExpr],20,makeUnionExpr],[XPathPathExpr,[XPathLocationPath],20,passExpr],
[XPathPathExpr,[XPathFilterExpr],19,passExpr],[XPathPathExpr,[XPathFilterExpr,TOK_SLASH,XPathRelativeLocationPath],19,makePathExpr1],[XPathPathExpr,[XPathFilterExpr,TOK_DSLASH,XPathRelativeLocationPath],19,makePathExpr2],[XPathFilterExpr,[XPathPrimaryExpr,XPathPredicate,Q_MM],31,makeFilterExpr],[XPathExpr,[XPathPrimaryExpr],16,passExpr],[XPathExpr,[XPathUnionExpr],16,passExpr],[XPathExpr,[TOK_MINUS,XPathExpr],-1,makeUnaryMinusExpr],[XPathExpr,[XPathExpr,TOK_OR,XPathExpr],-1,makeBinaryExpr],[XPathExpr,
[XPathExpr,TOK_AND,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_EQ,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_NEQ,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_LT,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_LE,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_GT,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_GE,XPathExpr],-1,makeBinaryExpr],[XPathExpr,[XPathExpr,TOK_PLUS,XPathExpr],-1,makeBinaryExpr,ASSOC_LEFT],[XPathExpr,[XPathExpr,TOK_MINUS,
XPathExpr],-1,makeBinaryExpr,ASSOC_LEFT],[XPathExpr,[XPathExpr,TOK_ASTERISK,XPathExpr],-1,makeBinaryExpr,ASSOC_LEFT],[XPathExpr,[XPathExpr,TOK_DIV,XPathExpr],-1,makeBinaryExpr,ASSOC_LEFT],[XPathExpr,[XPathExpr,TOK_MOD,XPathExpr],-1,makeBinaryExpr,ASSOC_LEFT],[XPathLiteral,[TOK_LITERALQ],-1,makeLiteralExpr],[XPathLiteral,[TOK_LITERALQQ],-1,makeLiteralExpr],[XPathNumber,[TOK_NUMBER],-1,makeNumberExpr],[XPathVariableReference,[TOK_DOLLAR,TOK_QNAME],200,makeVariableReference]],xpathRules=[];
function xpathParseInit(){function a(g,k,h){g[k]||(g[k]=[]);g[k].push(h)}if(!xpathRules.length){xpathGrammarRules.sort(function(g,k){var h=g[1].length,i=k[1].length;return h<i?1:h>i?-1:0});for(var b=1,c=0;c<xpathNonTerminals.length;++c)xpathNonTerminals[c].key=b++;for(c=0;c<xpathTokenRules.length;++c)xpathTokenRules[c].key=b++;xpathLog("XPath parse INIT: "+b+" rules");for(c=0;c<xpathGrammarRules.length;++c){b=xpathGrammarRules[c];for(var d=b[1],e=d.length-1;e>=0;--e)if(d[e]==Q_1M){a(xpathRules,d[e-
1].key,b);break}else if(d[e]==Q_MM||d[e]==Q_01){a(xpathRules,d[e-1].key,b);--e}else{a(xpathRules,d[e].key,b);break}}xpathLog("XPath parse INIT: "+xpathRules.length+" rule bins");var f=0;mapExec(xpathRules,function(g){if(g)f+=g.length});xpathLog("XPath parse INIT: "+f/xpathRules.length+" average bin size")}}function xpathCollectDescendants(a,b,c){if(c&&b.getElementsByTagName)copyArray(a,b.getElementsByTagName(c));else for(b=b.firstChild;b;b=b.nextSibling){a.push(b);xpathCollectDescendants(a,b)}}
function xpathExtractTagNameFromNodeTest(a,b){if(a instanceof NodeTestName)return a.name;if(b&&a instanceof NodeTestAny||a instanceof NodeTestElementOrAttribute)return"*"}function xpathCollectDescendantsReverse(a,b){for(var c=b.lastChild;c;c=c.previousSibling){a.push(c);xpathCollectDescendantsReverse(a,c)}}function xpathDomEval(a,b){return xpathParse(a).evaluate(new ExprContext(b))}
function xpathSort(a,b){if(b.length!=0){for(var c=[],d=0;d<a.contextSize();++d){var e=a.nodelist[d],f={node:e,key:[]};e=a.clone(e,0,[e]);for(var g=0;g<b.length;++g){var k=b[g],h=k.expr.evaluate(e),i;if(k.type=="text")i=h.stringValue();else if(k.type=="number")i=h.numberValue();f.key.push({value:i,order:k.order})}f.key.push({value:d,order:"ascending"});c.push(f)}c.sort(xpathSortByKey);f=[];for(d=0;d<c.length;++d)f.push(c[d].node);a.nodelist=f;a.setNode(0)}}
function xpathSortByKey(a,b){for(var c=0;c<a.key.length;++c){var d=a.key[c].order=="descending"?-1:1;if(a.key[c].value>b.key[c].value)return+1*d;else if(a.key[c].value<b.key[c].value)return-1*d}return 0}function xpathEval(a,b){return xpathParse(a).evaluate(b)}function xsltProcess(a,b){var c=domCreateDocumentFragment(new XDocument);xsltProcessContext(new ExprContext(a),b,c);return xmlText(c,true)}
function xsltProcessContext(a,b,c){var d=xmlOwnerDocument(c),e=b.nodeName.split(/:/);if(e.length==1||e[0]!="xsl")xsltPassThrough(a,b,c,d);else switch(e[1]){case "apply-imports":console.log("not implemented: "+e[1]);break;case "apply-templates":e=(e=xmlGetAttribute(b,"select"))?xpathEval(e,a).nodeSetValue():a.node.childNodes;a=a.clone(e[0],0,e);xsltWithParam(a,b);xsltSort(a,b);var f=xmlGetAttribute(b,"mode");d=b.ownerDocument.documentElement;e=[];for(b=0;b<d.childNodes.length;++b){var g=d.childNodes[b];
g.nodeType==DOM_ELEMENT_NODE&&g.nodeName=="xsl:template"&&g.getAttribute("mode")==f&&e.push(g)}for(d=0;d<a.contextSize();++d){g=a.nodelist[d];for(b=0;b<e.length;++b)xsltProcessContext(a.clone(g,d),e[b],c)}break;case "attribute":e=xmlGetAttribute(b,"name");e=xsltAttributeValue(e,a);g=domCreateDocumentFragment(d);xsltChildNodes(a,b,g);a=xmlValue(g);domSetAttribute(c,e,a);break;case "attribute-set":console.log("not implemented: "+e[1]);break;case "call-template":e=xmlGetAttribute(b,"name");d=b.ownerDocument.documentElement;
a=a.clone();xsltWithParam(a,b);for(b=0;b<d.childNodes.length;++b){g=d.childNodes[b];if(g.nodeType==DOM_ELEMENT_NODE&&g.nodeName=="xsl:template"&&domGetAttribute(g,"name")==e){xsltChildNodes(a,g,c);break}}break;case "choose":xsltChoose(a,b,c);break;case "comment":g=domCreateDocumentFragment(d);xsltChildNodes(a,b,g);b=xmlValue(g);b=domCreateComment(d,b);c.appendChild(b);break;case "copy":(g=xsltCopy(c,a.node,d))&&xsltChildNodes(a,b,g);break;case "copy-of":e=xmlGetAttribute(b,"select");a=xpathEval(e,
a);if(a.type=="node-set"){e=a.nodeSetValue();for(b=0;b<e.length;++b)xsltCopyOf(c,e[b],d)}else{g=domCreateTextNode(d,a.stringValue());domAppendChild(c,g)}break;case "decimal-format":console.log("not implemented: "+e[1]);break;case "element":e=xmlGetAttribute(b,"name");e=xsltAttributeValue(e,a);g=domCreateElement(d,e);domAppendChild(c,g);xsltChildNodes(a,b,g);break;case "fallback":console.log("not implemented: "+e[1]);break;case "for-each":xsltForEach(a,b,c);break;case "if":d=xmlGetAttribute(b,"test");
xpathEval(d,a).booleanValue()&&xsltChildNodes(a,b,c);break;case "import":console.log("not implemented: "+e[1]);break;case "include":console.log("not implemented: "+e[1]);break;case "key":console.log("not implemented: "+e[1]);break;case "message":console.log("not implemented: "+e[1]);break;case "namespace-alias":console.log("not implemented: "+e[1]);break;case "number":console.log("not implemented: "+e[1]);break;case "otherwise":console.log("error if here: "+e[1]);break;case "output":break;case "preserve-space":console.log("not implemented: "+
e[1]);break;case "processing-instruction":console.log("not implemented: "+e[1]);break;case "sort":break;case "strip-space":console.log("not implemented: "+e[1]);break;case "stylesheet":case "transform":xsltChildNodes(a,b,c);break;case "template":(d=xmlGetAttribute(b,"match"))&&xsltMatch(d,a)&&xsltChildNodes(a,b,c);break;case "text":b=xmlValue(b);g=domCreateTextNode(d,b);c.appendChild(g);break;case "value-of":e=xmlGetAttribute(b,"select");a=xpathEval(e,a).stringValue();g=xmlGetAttribute(b,"disable-output-escaping")==
"yes"?domCreateCDATASection(d,a):domCreateTextNode(d,a);c.appendChild(g);break;case "param":xsltVariable(a,b,false);break;case "variable":xsltVariable(a,b,true);break;case "when":console.log("error if here: "+e[1]);break;case "with-param":console.log("error if here: "+e[1]);break;default:console.log("error if here: "+e[1])}}function xsltWithParam(a,b){for(var c=0;c<b.childNodes.length;++c){var d=b.childNodes[c];d.nodeType==DOM_ELEMENT_NODE&&d.nodeName=="xsl:with-param"&&xsltVariable(a,d,true)}}
function xsltSort(a,b){for(var c=[],d=0;d<b.childNodes.length;++d){var e=b.childNodes[d];if(e.nodeType==DOM_ELEMENT_NODE&&e.nodeName=="xsl:sort"){var f=xmlGetAttribute(e,"select");f=xpathParse(f);var g=xmlGetAttribute(e,"data-type")||"text";e=xmlGetAttribute(e,"order")||"ascending";c.push({expr:f,type:g,order:e})}}xpathSort(a,c)}
function xsltVariable(a,b,c){var d=xmlGetAttribute(b,"name"),e=xmlGetAttribute(b,"select");if(b.childNodes.length>0){e=domCreateDocumentFragment(b.ownerDocument);xsltChildNodes(a,b,e);b=new NodeSetValue([e])}else b=e?xpathEval(e,a):new StringValue("");if(c||!a.getVariable(d))a.setVariable(d,b)}
function xsltChoose(a,b,c){for(var d=0;d<b.childNodes.length;++d){var e=b.childNodes[d];if(e.nodeType==DOM_ELEMENT_NODE)if(e.nodeName=="xsl:when"){var f=xmlGetAttribute(e,"test");if(xpathEval(f,a).booleanValue()){xsltChildNodes(a,e,c);break}}else if(e.nodeName=="xsl:otherwise"){xsltChildNodes(a,e,c);break}}}
function xsltForEach(a,b,c){var d=xmlGetAttribute(b,"select");d=xpathEval(d,a).nodeSetValue();a=a.clone(d[0],0,d);xsltSort(a,b);for(d=0;d<a.contextSize();++d)xsltChildNodes(a.clone(a.nodelist[d],d),b,c)}function xsltChildNodes(a,b,c){a=a.clone();for(var d=0;d<b.childNodes.length;++d)xsltProcessContext(a,b.childNodes[d],c)}
function xsltPassThrough(a,b,c,d){if(b.nodeType==DOM_TEXT_NODE){if(xsltPassText(b)){d=domCreateTextNode(d,b.nodeValue);domAppendChild(c,d)}}else if(b.nodeType==DOM_ELEMENT_NODE){d=domCreateElement(d,b.nodeName);for(var e=0;e<b.attributes.length;++e){var f=b.attributes[e];if(f){var g=f.nodeName;f=xsltAttributeValue(f.nodeValue,a);domSetAttribute(d,g,f)}}domAppendChild(c,d);xsltChildNodes(a,b,d)}else xsltChildNodes(a,b,c)}
function xsltPassText(a){if(!a.nodeValue.match(/^\s*$/))return true;a=a.parentNode;if(a.nodeName=="xsl:text")return true;for(;a&&a.nodeType==DOM_ELEMENT_NODE;){var b=domGetAttribute(a,"xml:space");if(b)if(b=="default")break;else if(b=="preserve")return true;a=a.parentNode}return false}
function xsltAttributeValue(a,b){var c=stringSplit(a,"{");if(c.length==1)return a;for(var d="",e=0;e<c.length;++e){var f=stringSplit(c[e],"}");if(f.length!=2)d+=c[e];else{var g=xpathEval(f[0],b).stringValue();d+=g+f[1]}}return d}function xmlGetAttribute(a,b){var c=domGetAttribute(a,b);return c?xmlResolveEntities(c):c}
function xsltCopyOf(a,b,c){if(b.nodeType==DOM_DOCUMENT_FRAGMENT_NODE||b.nodeType==DOM_DOCUMENT_NODE)for(var d=0;d<b.childNodes.length;++d)arguments.callee(a,b.childNodes[d],c);else{var e=xsltCopy(a,b,c);if(e){for(d=0;d<b.attributes.length;++d)arguments.callee(e,b.attributes[d],c);for(d=0;d<b.childNodes.length;++d)arguments.callee(e,b.childNodes[d],c)}}}
function xsltCopy(a,b,c){if(b.nodeType==DOM_ELEMENT_NODE){b=domCreateElement(c,b.nodeName);domAppendChild(a,b);return b}if(b.nodeType==DOM_TEXT_NODE){b=domCreateTextNode(c,b.nodeValue);domAppendChild(a,b)}else if(b.nodeType==DOM_CDATA_SECTION_NODE){b=domCreateCDATASection(c,b.nodeValue);domAppendChild(a,b)}else if(b.nodeType==DOM_COMMENT_NODE){b=domCreateComment(c,b.nodeValue);domAppendChild(a,b)}else b.nodeType==DOM_ATTRIBUTE_NODE&&domSetAttribute(a,b.nodeName,b.nodeValue);return null}
function xsltMatch(a,b){var c=xpathParse(a),d;if(c.steps&&!c.absolute&&c.steps.length==1&&c.steps[0].axis=="child"&&c.steps[0].predicate.length==0)d=c.steps[0].nodetest.evaluate(b).booleanValue();else{d=false;for(var e=b.node;!d&&e;){for(var f=c.evaluate(b.clone(e,0,[e])).nodeSetValue(),g=0;g<f.length;++g)if(f[g]==b.node){d=true;break}e=e.parentNode}}return d};
